<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vorwerk Inventario | Firebase Cloud</title>
    <style>
        :root {
            --primary: #0033a0; --accent: #5bc2e7; 
            --bg: #f0f4f8; --card: #ffffff; --text: #1e293b; --danger: #ef4444;
            --sidebar-width: 260px; --border: #e2e8f0;
        }

        body.dark-mode {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9;
            --border: #334155; --primary: #3b82f6;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }
        
        aside { width: var(--sidebar-width); background: #0033a0; color: white; display: flex; flex-direction: column; padding: 20px; z-index: 100; flex-shrink: 0; }
        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo { max-width: 100%; height: auto; filter: brightness(0) invert(1); }
        .brand-name { font-size: 0.9rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-bottom: 20px; text-align: center; }

        nav { display: flex; flex-direction: column; gap: 8px; }
        nav button { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px 15px; cursor: pointer; border-radius: 8px; text-align: left; transition: 0.3s; font-size: 0.95rem; }
        nav button.active { background: var(--accent); color: #0033a0; font-weight: bold; }

        main { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .section { display: none; max-width: 1200px; margin: 0 auto; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .category-group { margin-bottom: 40px; }
        .category-title { background: var(--card); padding: 15px 20px; border-radius: 10px; color: var(--primary); font-weight: bold; margin-bottom: 20px; border-left: 6px solid var(--primary); display: flex; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(480px, 1fr)); gap: 2rem; }
        .card { background: var(--card); border-radius: 15px; overflow: hidden; display: flex; height: 260px; position: relative; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .card-info { flex: 1.2; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; }
        .card-img-container { flex: 1; background: rgba(0,0,0,0.02); display: flex; align-items: center; justify-content: center; border-left: 1px solid var(--border); padding: 15px; }
        .card-img-side { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; }
        
        .card h3 { margin: 0; font-size: 1.35rem; color: var(--primary); padding-right: 35px; }
        .card p { font-size: 0.85rem; opacity: 0.8; margin: 8px 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .stock-val { font-size: 2.2rem; font-weight: 800; margin: 10px 0; }
        
        .btn-manage { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-link { flex: 1; text-align: center; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; transition: 0.3s; height: 40px; }
        .link-active { background: var(--accent); color: #0033a0; }
        .link-disabled { background: #94a3b8; color: #f1f5f9; cursor: not-allowed; opacity: 0.7; }

        .btn-edit-icon { position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; font-size: 1.2rem; color: var(--text); opacity: 0.5; }
        .btn-delete-text { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 0.75rem; text-decoration: underline; margin-top: 5px; padding: 0; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-content { background: var(--card); padding: 35px; border-radius: 20px; width: 500px; max-height: 90vh; overflow-y: auto; color: var(--text); }
        
        form label { display: block; margin-bottom: 8px; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; }
        form input, form select, form textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: rgba(0,0,0,0.03); color: var(--text); box-sizing: border-box; }
        
        .upload-area { border: 1px dashed var(--border); padding: 20px; text-align: center; cursor: pointer; border-radius: 12px; margin-bottom: 20px; }

        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; }
        th, td { text-align: left; padding: 15px; border-bottom: 1px solid var(--border); }
        th { background: rgba(0,0,0,0.03); color: var(--primary); font-size: 0.8rem; }
    </style>
</head>
<body id="body">

<aside>
    <div class="logo-container"><img src="https://i.ibb.co/Lhb8Z3m/image-a7367b.png" alt="Vorwerk" class="logo"></div>
    <div class="brand-name">VORWERK CLOUD</div>
    <nav>
        <button onclick="showSection('productos', this)" class="active">üì¶ Inventario</button>
        <button onclick="showSection('carga', this)">‚ûï A√±adir Producto</button>
        <button onclick="showSection('ajustes', this)">‚öôÔ∏è Ajustes</button>
        <button onclick="showSection('historial', this)">üìú Historial</button>
    </nav>
</aside>

<main>
    <section id="productos" class="section active">
        <h2 style="margin-top:0">Stock Actual (Nube)</h2>
        <div id="inventory-container">Cargando datos...</div>
    </section>

    <section id="carga" class="section">
        <h2>Registrar Nuevo Art√≠culo</h2>
        <div style="max-width: 600px; background: var(--card); padding: 30px; border-radius: 15px; border: 1px solid var(--border);">
            <form id="form-producto">
                <label>Imagen del Producto</label>
                <div class="upload-area" onclick="document.getElementById('file-input').click()">
                    <span id="label-img">üì∏ Haz clic o PEGA imagen</span>
                    <center><img id="preview-box" style="max-height:140px; display:none; margin-top:10px; border-radius:10px;"></center>
                    <input type="file" id="file-input" accept="image/*" hidden onchange="handleFile(this.files[0], 'preview-box', 'label-img', 'add')">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div><label>Nombre</label><input type="text" id="p-titulo" required></div>
                    <div><label>Categor√≠a</label>
                        <select id="p-cat">
                            <option value="Herramientas">Herramientas</option>
                            <option value="Insumos">Insumos</option>
                            <option value="Consumibles">Consumibles</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom:20px;"><label>Descripci√≥n</label><textarea id="p-desc" rows="2"></textarea></div>
                <div style="margin-bottom:20px;"><label>Link Externo</label><input type="url" id="p-link"></div>
                <button type="submit" class="btn-manage" style="background: #059669; width:100%; height:45px;">Guardar en Firebase</button>
            </form>
        </div>
    </section>

    <section id="ajustes" class="section">
        <h2>Configuraci√≥n</h2>
        <div style="background:var(--card); padding:25px; border-radius:15px; border: 1px solid var(--border); max-width: 600px;">
            <h3>T√©cnicos</h3>
            <div style="display:flex; gap:10px;"><input type="text" id="new-tech" style="margin:0; flex:1"><button onclick="addTech()" class="btn-manage">A√±adir</button></div>
            <div id="tech-list" style="margin-top:15px"></div>
        </div>
    </section>

    <section id="historial" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h2>Historial Reciente</h2></div>
        <table><thead><tr><th>Fecha</th><th>Producto</th><th>Ant.</th><th>Cambio</th><th>Final</th><th>Responsable</th></tr></thead><tbody id="history-table"></tbody></table>
    </section>
</main>

<div id="modal-edit" class="modal">
    <div class="modal-content">
        <h3>MODIFICAR ART√çCULO</h3>
        <form id="form-edit-producto">
            <div class="upload-area" onclick="document.getElementById('edit-file-input').click()">
                <center><img id="edit-preview-box" style="max-height:120px; border-radius:8px; display:block;"></center>
                <input type="file" id="edit-file-input" accept="image/*" hidden onchange="handleFile(this.files[0], 'edit-preview-box', null, 'edit')">
            </div>
            <input type="text" id="edit-p-titulo" placeholder="Nombre" style="margin-bottom:10px">
            <select id="edit-p-cat" style="margin-bottom:10px"><option value="Herramientas">Herramientas</option><option value="Insumos">Insumos</option><option value="Consumibles">Consumibles</option><option value="Otros">Otros</option></select>
            <textarea id="edit-p-desc" rows="3" style="margin-bottom:10px"></textarea>
            <input type="url" id="edit-p-link" placeholder="Link" style="margin-bottom:20px">
            <button type="button" onclick="saveProductEdits()" class="btn-manage" style="width:100%;">Actualizar</button>
            <button type="button" onclick="closeModal('modal-edit')" style="width:100%; margin-top:10px; background:gray; color:white; border:none; padding:10px; border-radius:8px;">Cancelar</button>
        </form>
    </div>
</div>

<div id="modal-gestion" class="modal">
    <div class="modal-content" style="text-align:center; width: 400px;">
        <h3 id="modal-title"></h3>
        <select id="select-tech-modal" style="margin-bottom: 20px;"></select>
        <div style="display:flex; justify-content:center; align-items:center; gap:25px; margin-bottom: 30px;">
            <button onclick="adjustQty(-1)" style="width:40px; height:40px;">-</button>
            <input type="number" id="qty-input" style="width:80px; text-align:center; font-size:1.5rem;">
            <button onclick="adjustQty(1)" style="width:40px; height:40px;">+</button>
        </div>
        <button onclick="saveStockChange()" class="btn-manage" style="width:100%;">Confirmar</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. CONFIGURACI√ìN DE TU PROYECTO (Reemplaza con tus datos de Firebase)
    const firebaseConfig = {
        apiKey: "AIzaSyCQdBKA_5P7LW3qXK9Z32WjTWghG2XxlvI",
        authDomain: "prompt-67f0e.firebaseapp.com",
        projectId: "prompt-67f0e",
        storageBucket: "prompt-67f0e.firebasestorage.app",
        messagingSenderId: "802457033921",
        appId: "1:802457033921:web:038c7723e9ab261dbfc840",
        measurementId: "G-D86V4M9Q0Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variables de estado
    let productos = [];
    let tecnicos = ["Administrador"];
    let currentEditId = null;
    let base64Img = "";
    let editBase64Img = "";

    // --- ESCUCHADORES EN TIEMPO REAL ---

    // Escuchar Productos
    onSnapshot(collection(db, "productos"), (snapshot) => {
        productos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderProductos();
    });

    // Escuchar Historial (√∫ltimos 50)
    const qHistorial = query(collection(db, "historial"), orderBy("fecha", "desc"), limit(50));
    onSnapshot(qHistorial, (snapshot) => {
        const historial = snapshot.docs.map(doc => doc.data());
        renderHistorial(historial);
    });

    // Escuchar T√©cnicos
    onSnapshot(collection(db, "tecnicos"), (snapshot) => {
        if (!snapshot.empty) {
            tecnicos = snapshot.docs.map(doc => doc.data().nombre);
        }
        renderTecnicos();
    });

    // --- FUNCIONES CORE ---

    window.handleFile = (file, previewId, labelId, mode) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            if(mode === 'add') base64Img = e.target.result; else editBase64Img = e.target.result;
            const preview = document.getElementById(previewId);
            preview.src = e.target.result; preview.style.display = 'block';
            if(labelId) document.getElementById(labelId).style.display = 'none';
        };
        reader.readAsDataURL(file);
    };

    document.getElementById('form-producto').onsubmit = async (e) => {
        e.preventDefault();
        const p = {
            titulo: document.getElementById('p-titulo').value,
            desc: document.getElementById('p-desc').value,
            cat: document.getElementById('p-cat').value,
            link: document.getElementById('p-link').value || '',
            img: base64Img || '',
            stock: 0,
            fechaCreacion: new Date().toISOString()
        };

        try {
            await addDoc(collection(db, "productos"), p);
            await addDoc(collection(db, "historial"), {
                fecha: new Date().toLocaleString(),
                prod: p.titulo,
                ant: 0,
                cambio: "CREADO",
                final: 0,
                tech: "Sistema"
            });
            e.target.reset();
            document.getElementById('preview-box').style.display = 'none';
            document.getElementById('label-img').style.display = 'block';
            base64Img = "";
            alert("Producto guardado en la nube");
        } catch (err) { console.error(err); }
    };

    window.saveStockChange = async () => {
        const p = productos.find(x => x.id === currentEditId);
        const nuevo = parseInt(document.getElementById('qty-input').value) || 0;
        const diff = nuevo - p.stock;

        if(diff !== 0) {
            await updateDoc(doc(db, "productos", currentEditId), { stock: nuevo });
            await addDoc(collection(db, "historial"), {
                fecha: new Date().toLocaleString(),
                prod: p.titulo,
                ant: p.stock,
                cambio: diff > 0 ? `+${diff}` : diff,
                final: nuevo,
                tech: document.getElementById('select-tech-modal').value
            });
            closeModal('modal-gestion');
        } else closeModal('modal-gestion');
    };

    window.saveProductEdits = async () => {
        const pRef = doc(db, "productos", currentEditId);
        await updateDoc(pRef, {
            titulo: document.getElementById('edit-p-titulo').value,
            cat: document.getElementById('edit-p-cat').value,
            desc: document.getElementById('edit-p-desc').value,
            link: document.getElementById('edit-p-link').value,
            img: editBase64Img
        });
        closeModal('modal-edit');
    };

    window.deleteProduct = async (id, titulo) => {
        if(confirm(`¬øEliminar ${titulo}?`)) {
            await deleteDoc(doc(db, "productos", id));
            await addDoc(collection(db, "historial"), {
                fecha: new Date().toLocaleString(),
                prod: titulo,
                ant: '-',
                cambio: "ELIMINADO",
                final: '-',
                tech: "Admin"
            });
        }
    };

    window.addTech = async () => {
        const nom = document.getElementById('new-tech').value;
        if(nom) {
            await addDoc(collection(db, "tecnicos"), { nombre: nom });
            document.getElementById('new-tech').value = '';
        }
    };

    // --- RENDERIZADO ---

    function renderProductos() {
        const container = document.getElementById('inventory-container');
        container.innerHTML = "";
        ["Herramientas", "Insumos", "Consumibles", "Otros"].forEach(cat => {
            const filtrados = productos.filter(p => p.cat === cat);
            if(filtrados.length > 0) {
                const group = document.createElement('div');
                group.className = 'category-group';
                group.innerHTML = `<div class="category-title"><span>${cat}</span></div><div class="grid">${filtrados.map(p => `
                    <div class="card">
                        <div class="card-info">
                            <button class="btn-edit-icon" onclick="openEditModal('${p.id}')">‚öôÔ∏è</button>
                            <h3>${p.titulo}</h3><p>${p.desc}</p>
                            <div class="stock-val">${p.stock} <small>uds</small></div>
                            <div style="display:flex; gap:10px">
                                <button class="btn-manage" style="flex:2" onclick="openManageModal('${p.id}')">STOCK</button>
                                ${p.link ? `<a href="${p.link}" target="_blank" class="btn-link link-active">LINK</a>` : `<a class="btn-link link-disabled">LINK</a>`}
                            </div>
                            <button class="btn-delete-text" onclick="deleteProduct('${p.id}', '${p.titulo}')">Eliminar</button>
                        </div>
                        <div class="card-img-container"><img src="${p.img || 'https://via.placeholder.com/150'}" class="card-img-side"></div>
                    </div>`).join('')}</div>`;
                container.appendChild(group);
            }
        });
    }

    function renderHistorial(datos) {
        document.getElementById('history-table').innerHTML = datos.map(h => `
            <tr>
                <td><small>${h.fecha}</small></td>
                <td><strong>${h.prod}</strong></td>
                <td>${h.ant}</td>
                <td style="color:${h.cambio.toString().includes('+') ? '#10b981' : 'red'}; font-weight:bold">${h.cambio}</td>
                <td>${h.final}</td>
                <td>${h.tech}</td>
            </tr>`).join('');
    }

    function renderTecnicos() {
        document.getElementById('tech-list').innerHTML = tecnicos.map(t => `<div style="padding:10px; background:var(--card); margin-bottom:5px; border-radius:5px; border:1px solid var(--border)">${t}</div>`).join('');
    }

    // --- UTILIDADES ---

    window.showSection = (id, btn) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active'); btn.classList.add('active');
    };

    window.openEditModal = (id) => {
        currentEditId = id; const p = productos.find(x => x.id === id);
        document.getElementById('edit-p-titulo').value = p.titulo;
        document.getElementById('edit-p-cat').value = p.cat;
        document.getElementById('edit-p-desc').value = p.desc;
        document.getElementById('edit-p-link').value = p.link;
        document.getElementById('edit-preview-box').src = p.img || '';
        editBase64Img = p.img;
        document.getElementById('modal-edit').style.display = 'flex';
    };

    window.openManageModal = (id) => {
        currentEditId = id; const p = productos.find(x => x.id === id);
        document.getElementById('modal-title').innerText = p.titulo;
        document.getElementById('qty-input').value = p.stock;
        document.getElementById('select-tech-modal').innerHTML = tecnicos.map(t => `<option value="${t}">${t}</option>`).join('');
        document.getElementById('modal-gestion').style.display = 'flex';
    };

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    window.adjustQty = (v) => document.getElementById('qty-input').value = (parseInt(document.getElementById('qty-input').value)||0) + v;
</script>
</body>
</html>